<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>keep-alive实现原理 | 峰享会</title>
  
  <meta name="keywords" content="前端开发,科技,数据可视化,移动开发,小程序,客户端">
  
  
  <meta name="description" content="集合了开发技能，生活趣事，未来科技，情感互动于一体。">
  

  
  <link rel="alternate" href="/./atom.xml" title="峰享会">
  

  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  
  
  <meta name="theme-color" content="#FFFFFF">
  <meta name="msapplication-TileColor" content="#1BC3FB">
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  
  
  <link rel="shortcut icon" type="image/x-icon" href="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/img/favicon.ico">
  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/css/style.css">
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>漫道求索</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="这里有你知道的一切" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-home fa-fw'></i>&nbsp;主页
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/blogpost/categories/"
            
              rel="nofollow"
            
            
            id="blogpostcategories">
            <i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/blogpost/tags/"
            
              rel="nofollow"
            
            
            id="blogposttags">
            <i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/blogpost/archives/"
            
              rel="nofollow"
            
            
            id="blogpostarchives">
            <i class='fas fa-archive fa-fw'></i>&nbsp;归档
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-user-friends fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header material">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="material"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          峰享会
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-home fa-fw'></i>&nbsp;主页
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blogpost/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="blogpostcategories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blogpost/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="blogposttags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blogpost/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="blogpostarchives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/friends/"
                  
                    rel="nofollow"
                  
                  
                  id="friends">
									<i class='fas fa-user-friends fa-fw'></i>&nbsp;友链
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/about/"
                  
                    rel="nofollow"
                  
                  
                  id="about">
									<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;所有文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blogpost/archives/"
                
                  rel="nofollow"
                
                
                id="blogpostarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blogpost/tags/"
                
                  rel="nofollow"
                
                
                id="blogposttags">
								<i class='fas fa-hashtag fa-fw'></i>&nbsp;所有标签
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/./atom.xml"
                
                  rel="nofollow"
                
                
                id=".atom.xml">
								<i class='fas fa-rss fa-fw'></i>&nbsp;RSS订阅
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于博主
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>

  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  
    <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/posts/e9fee5eb.html">
        keep-alive实现原理
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="https://yangyfeng.github.io" rel="nofollow">
      
        <img src="https://s2.ax1x.com/2019/07/12/Zhm4jf.jpg">
      
      <p>漫道求索</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2021-08-25</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blogpost/categories/前端/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>前端</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
        
          <!-- 文章字体个数 -->
          <div class="new-meta-item size">
            <a class="notlink">
              <i class="fas fa-edit" aria-hidden="true"></i>
              <p>2.6k字</p>
            </a>
          </div>
          <!-- 阅读时间 -->
          <div class="new-meta-item read-time">
            <a class="notlink">
              <i class="fas fa-desktop" aria-hidden="true"></i>
              <p>11分</p>
            </a>
          </div>
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          <h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>本文介绍的内容包括：</p>
<ul>
<li>keep-alive用法：动态组件&amp;vue-router</li>
<li>keep-alive源码解析</li>
<li>keep-alive组件及其包裹组件的钩子</li>
<li>keep-alive组件及其包裹组件的渲染</li>
</ul>
<h1 id="二、keep-alive介绍与应用"><a href="#二、keep-alive介绍与应用" class="headerlink" title="二、keep-alive介绍与应用"></a>二、keep-alive介绍与应用</h1><h2 id="2-1-keep-alive是什么"><a href="#2-1-keep-alive是什么" class="headerlink" title="2.1 keep-alive是什么"></a>2.1 keep-alive是什么</h2><blockquote>
<p>keep-alive是一个抽象组件：它自身不会渲染一个DOM元素，也不会出现在父组件链中；使用keep-alive包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。</p>
</blockquote>
<h2 id="一个场景"><a href="#一个场景" class="headerlink" title="一个场景"></a>一个场景</h2><p>用户在某个列表页面选择筛选条件过滤出一份数据列表，由列表页面进入数据详情页面，再返回该列表页面，我们希望：列表页面可以保留用户的筛选（或选中）状态。<br> keep-alive就是用来解决这种场景。当然keep-alive不仅仅是能够保存页面/组件的状态这么简单，它还可以避免组件反复创建和渲染，有效提升系统性能。总的来说，<strong>keep-alive用于保存组件的渲染状态。</strong></p>
<h2 id="keep-alive用法"><a href="#keep-alive用法" class="headerlink" title="keep-alive用法"></a>keep-alive用法</h2><ul>
<li><p>在动态组件中的应用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">:include</span>=<span class="string">"whiteList"</span> <span class="attr">:exclude</span>=<span class="string">"blackList"</span> <span class="attr">:max</span>=<span class="string">"amount"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">"currentComponent"</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在vue-router中的应用</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">:include</span>=<span class="string">"whiteList"</span> <span class="attr">:exclude</span>=<span class="string">"blackList"</span> <span class="attr">:max</span>=<span class="string">"amount"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>include</strong>定义缓存白名单，keep-alive会缓存命中的组件；<strong>exclude</strong>定义缓存黑名单，被命中的组件将不会被缓存；<strong>max</strong>定义缓存组件上限，超出上限使用LRU的策略置换缓存数据。</p>
<blockquote>
<p><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%2F5633616" target="_blank" rel="noopener">内存管理</a>的一种页面置换算法，对于在内存中但又不用的<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%E6%95%B0%E6%8D%AE%E5%9D%97%2F107672" target="_blank" rel="noopener">数据块</a>（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。</p>
</blockquote>
<h1 id="三、源码剖析"><a href="#三、源码剖析" class="headerlink" title="三、源码剖析"></a>三、源码剖析</h1><p>keep-alive.js内部还定义了一些工具函数，我们按住不动，先看它对外暴露的对象</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/components/keep-alive.js</span></span><br><span class="line">export <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'keep-alive'</span>,</span><br><span class="line">  <span class="keyword">abstract</span>: <span class="literal">true</span>, <span class="comment">// 判断当前组件虚拟dom是否渲染成真实dom的关键</span></span><br><span class="line">  props: &#123;</span><br><span class="line">      include: patternTypes, <span class="comment">// 缓存白名单</span></span><br><span class="line">      exclude: patternTypes, <span class="comment">// 缓存黑名单</span></span><br><span class="line">      max: [String, Number] <span class="comment">// 缓存的组件</span></span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">     <span class="keyword">this</span>.cache = Object.create(<span class="literal">null</span>) <span class="comment">// 缓存虚拟dom</span></span><br><span class="line">     <span class="keyword">this</span>.keys = [] <span class="comment">// 缓存的虚拟dom的键集合</span></span><br><span class="line">  &#125;,</span><br><span class="line">  destroyed() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="keyword">this</span>.cache) &#123;</span><br><span class="line">       <span class="comment">// 删除所有的缓存</span></span><br><span class="line">       pruneCacheEntry(<span class="keyword">this</span>.cache, key, <span class="keyword">this</span>.keys)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"> mounted() &#123;</span><br><span class="line">   <span class="comment">// 实时监听黑白名单的变动</span></span><br><span class="line">   <span class="keyword">this</span>.$watch(<span class="string">'include'</span>, <span class="keyword">val</span> =&gt; &#123;</span><br><span class="line">       pruneCache(<span class="keyword">this</span>, name =&gt; matched(<span class="keyword">val</span>, name))</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="keyword">this</span>.$watch(<span class="string">'exclude'</span>, <span class="keyword">val</span> =&gt; &#123;</span><br><span class="line">       pruneCache(<span class="keyword">this</span>, name =&gt; !matches(<span class="keyword">val</span>, name))</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br><span class="line"> render() &#123;</span><br><span class="line">    <span class="comment">// 先省略...</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>可以看出，与我们定义组件的过程一样，先是设置组件名为keep-alive，其次定义了一个abstract属性，值为true。这个属性在vue的官方教程并未提及，却至关重要，后面的渲染过程会用到。props属性定义了keep-alive组件支持的全部参数。</p>
<p>keep-alive在它生命周期内定义了三个钩子函数：</p>
<ul>
<li>created<br> 初始化两个对象分别缓存VNode(虚拟DOM)和VNode对应的键集合</li>
<li>destroyed<br> 删除this.cache中缓存的VNode实例。我们留意到，这不是简单地将this.cache置为null，而是遍历调用pruneCacheEntry函数删除。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// src/core/components/keep-alive.js</span><br><span class="line">function pruneCacheEntry (</span><br><span class="line">  cache: VNodeCache,</span><br><span class="line">  key: string,</span><br><span class="line">  keys: Array&lt;string&gt;,</span><br><span class="line">  current?: VNode</span><br><span class="line">) &#123;</span><br><span class="line"> const cached = cache[key]</span><br><span class="line"> if (cached &amp;&amp; (!current || cached.tag !== current.tag)) &#123;</span><br><span class="line">    cached.componentInstance.$destroyed() // 执行组件的destroy钩子函数</span><br><span class="line"> &#125;</span><br><span class="line"> cache[key] = null</span><br><span class="line"> remove(keys, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>删除缓存的VNode还要对应组件实例的destory钩子函数</p>
<ul>
<li>mounted<br> 在mounted这个钩子中对include和exclude参数进行监听，然后实时地更新（删除）this.cache对象数据。pruneCache函数的核心也是去调用pruneCacheEntry</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function pruneCache (keepAliveInstance: any, filter: Function) &#123;</span><br><span class="line">  const &#123; cache, keys, _vnode &#125; = keepAliveInstance</span><br><span class="line">  for (const key in cache) &#123;</span><br><span class="line">    const cachedNode: ?VNode = cache[key]</span><br><span class="line">    if (cachedNode) &#123;</span><br><span class="line">      const name: ?string = getComponentName(cachedNode.componentOptions)</span><br><span class="line">      if (name &amp;&amp; !filter(name)) &#123;</span><br><span class="line">        pruneCacheEntry(cache, key, keys, _vnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>render</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">render () &#123;</span><br><span class="line">  <span class="keyword">const</span> slot = <span class="keyword">this</span>.$slots.defalut</span><br><span class="line">  <span class="keyword">const</span> vnode: VNode = getFirstComponentChild(slot) <span class="comment">// 找到第一个子组件对象</span></span><br><span class="line">  <span class="keyword">const</span> componentOptions : ?VNodeComponentOptions = vnode &amp;&amp; vnode.componentOptions</span><br><span class="line">  <span class="keyword">if</span> (componentOptions) &#123; <span class="comment">// 存在组件参数</span></span><br><span class="line">    <span class="comment">// check pattern</span></span><br><span class="line">    <span class="keyword">const</span> name: ?string = getComponentName(componentOptions) <span class="comment">// 组件名</span></span><br><span class="line">    <span class="keyword">const</span> &#123; include, exclude &#125; = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="comment">// 条件匹配</span></span><br><span class="line">      <span class="comment">// not included</span></span><br><span class="line">      （include &amp;&amp; (!name || !matches(include, name))）||</span><br><span class="line">      <span class="comment">// excluded</span></span><br><span class="line">        (exclude &amp;&amp; name &amp;&amp; matches(exclude, name))</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> vnode</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> &#123; cache, keys &#125; = <span class="keyword">this</span></span><br><span class="line">    <span class="comment">// 定义组件的缓存key</span></span><br><span class="line">    <span class="keyword">const</span> key: ?string = vnode.key === <span class="literal">null</span> ? componentOptions.Ctor.cid + (componentOptions.tag ? `::$&#123;componentOptions.tag&#125;` : <span class="string">''</span>) : vnode.key</span><br><span class="line">     <span class="keyword">if</span> (cache[key]) &#123; <span class="comment">// 已经缓存过该组件</span></span><br><span class="line">        vnode.componentInstance = cache[key].componentInstance</span><br><span class="line">        remove(keys, key)</span><br><span class="line">        keys.push(key) <span class="comment">// 调整key排序</span></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cache[key] = vnode <span class="comment">//缓存组件对象</span></span><br><span class="line">        keys.push(key)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.max &amp;&amp; keys.length &gt; parseInt(<span class="keyword">this</span>.max)) &#123;</span><br><span class="line">          <span class="comment">//超过缓存数限制，将第一个删除</span></span><br><span class="line">          pruneCacheEntry(cahce, keys[<span class="number">0</span>], keys, <span class="keyword">this</span>._vnode)</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">      vnode.<span class="keyword">data</span>.keepAlive = <span class="literal">true</span> <span class="comment">//渲染和执行被包裹组件的钩子函数需要用到</span></span><br><span class="line"> </span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> vnode || (slot &amp;&amp; slot[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一步：获取keep-alive包裹着的第一个子组件对象及其组件名；</li>
<li>第二步：根据设定的黑白名单（如果有）进行条件匹配，决定是否缓存。不匹配，直接返回组件实例（VNode），否则执行第三步；</li>
<li>第三步：根据组件ID和tag生成缓存Key，并在缓存对象中查找是否已缓存过该组件实例。如果存在，直接取出缓存值并更新该key在this.keys中的位置（更新key的位置是实现LRU置换策略的关键），否则执行第四步；</li>
<li>第四步：在this.cache对象中存储该组件实例并保存key值，之后检查缓存的实例数量是否超过max设置值，超过则根据LRU置换策略删除最近最久未使用的实例（即是下标为0的那个key）;</li>
<li>第五步：最后并且很重要，将该组件实例的keepAlive属性值设置为true。</li>
</ul>
<h1 id="四、重头戏：渲染"><a href="#四、重头戏：渲染" class="headerlink" title="四、重头戏：渲染"></a>四、重头戏：渲染</h1><h2 id="4-1-Vue的渲染过程"><a href="#4-1-Vue的渲染过程" class="headerlink" title="4.1 Vue的渲染过程"></a>4.1 Vue的渲染过程</h2><p>借助一张图看下Vue渲染的整个过程：</p>
<p><a href="https://imgtu.com/i/hE5pPU" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/img/loading.gif" data-original="https://z3.ax1x.com/2021/08/25/hE5pPU.png" alt="hE5pPU.png"></a></p>
<p>Vue的渲染是从图中render阶段开始的，但keep-alive的渲染是在patch阶段，这是构建组件树（虚拟DOM树），并将VNode转换成真正DOM节点的过程。<br><strong>简单描述从render到patch的过程</strong><br> 我们从最简单的new Vue开始：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Vue在渲染的时候先调用原型上的_render函数将组件对象转化成一个VNode实例；而_render是通过调用createElement和createEmptyVNode两个函数进行转化；</li>
<li>createElement的转化过程会根据不同的情形选择new VNode或者调用createComponent函数做VNode实例化；</li>
<li>完成VNode实例化后，这时候Vue调用原型上的_update函数把VNode渲染成真实DOM，这个过程又是通过调用<strong>patch</strong>函数完成的（这就是patch阶段了）<br> 用一张图表达：</li>
</ul>
<p><a href="https://imgtu.com/i/hE53qI" target="_blank" rel="noopener"><img src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/img/loading.gif" data-original="https://z3.ax1x.com/2021/08/25/hE53qI.png" alt="hE53qI.png"></a></p>
<h2 id="4-2-keep-alive组件的渲染"><a href="#4-2-keep-alive组件的渲染" class="headerlink" title="4.2 keep-alive组件的渲染"></a>4.2 keep-alive组件的渲染</h2><p>我们用过keep-alive都知道，它不会生成真正的DOM节点，这是怎么做到的？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/lifecycle.js</span></span><br><span class="line">export <span class="function"><span class="keyword">function</span> <span class="title">initLifecycle</span> <span class="params">(vm: Component)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> options= vm.$options</span><br><span class="line">    <span class="comment">// 找到第一个非abstract父组件实例</span></span><br><span class="line">    let <span class="keyword">parent</span> = options.<span class="keyword">parent</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">parent</span> &amp;&amp; !options.<span class="keyword">abstract</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">parent</span>.$options.<span class="keyword">abstract</span> &amp;&amp; <span class="keyword">parent</span>.$parent) &#123;</span><br><span class="line">              <span class="keyword">parent</span> = <span class="keyword">parent</span>.$parent</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">parent</span>.$children.push(vm)</span><br><span class="line">    &#125;</span><br><span class="line">    vm.$parent = <span class="keyword">parent</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Vue在初始化生命周期的时候，为组件实例建立父子关系会根据abstract属性决定是否忽略某个组件。在keep-alive中，设置了abstract:true，那Vue就会跳过该组件实例。</p>
<p><strong>最后构建的组件树中就不会包含keep-alive组件，那么由组件树渲染成的DOM树自然也不会有keep-alive相关的节点了。</strong></p>
<p><strong>keep-alive包裹的组件是如何使用缓存的？</strong><br> 在patch阶段，会执行createComponent函数：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/vdom/patch.js</span></span><br><span class="line"><span class="function">function <span class="title">createComponent</span> (<span class="params">vnode, insertedVnodeQueue, parentElm, refElm</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> i = vnode.data</span><br><span class="line">    <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">        <span class="keyword">const</span> isReactivated = isDef(vnode.componentInstance) &amp;&amp; i.keepAlive</span><br><span class="line">        <span class="keyword">if</span> (isDef(i = i.hook) &amp;&amp; isDef(i = i.init)) &#123;</span><br><span class="line">            i(vnode, <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isDef(vnode.componentInstance)) &#123;</span><br><span class="line">            initComponent(vnode, insertedVnodeQueue)</span><br><span class="line">            insert(parentElem, vnode.elem, refElem) <span class="comment">// 将缓存的DOM(vnode.elem) 插入父元素中</span></span><br><span class="line">            <span class="keyword">if</span> (isTrue(isReactivated)) &#123;</span><br><span class="line">                reactivateComponent(vnode, insertedVnodeQueue, parentEle, refElm)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在首次加载被包裹组建时，由keep-alive.js中的render函数可知，vnode.componentInstance的值是undfined，keepAlive的值是true，因为keep-alive组件作为父组件，它的render函数会先于被包裹组件执行；那么只执行到i(vnode,false)，后面的逻辑不执行；</li>
<li>再次访问被包裹组件时，vnode.componentInstance的值就是已经缓存的组件实例，那么会执行insert(parentElm, vnode.elm, refElm)逻辑，这样就直接把上一次的DOM插入到父元素中。</li>
</ul>
<h1 id="五、不可忽视：钩子函数"><a href="#五、不可忽视：钩子函数" class="headerlink" title="五、不可忽视：钩子函数"></a>五、不可忽视：钩子函数</h1><h2 id="5-1-只执行一次的钩子"><a href="#5-1-只执行一次的钩子" class="headerlink" title="5.1 只执行一次的钩子"></a>5.1 只执行一次的钩子</h2><p>一般的组件，每一次加载都会有完整的生命周期，即生命周期里面对于的钩子函数都会被触发，为什么被keep-alive包裹的组件却不是呢？<br> 被缓存的组件实例会为其设置keepAlive= true，而在初始化组件钩子函数中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// src/core/vdom/create-component.js</span><br><span class="line">const componentVNodeHooks = &#123;</span><br><span class="line">    init (vnode: VNodeWithData, hydrating: boolean): ?boolean&#123;</span><br><span class="line">        if (</span><br><span class="line">         vnode.componentInstance &amp;&amp;       </span><br><span class="line">         !vnode.componentInstance._isDestroyed &amp;&amp;</span><br><span class="line">         vnode.data.keepAlive</span><br><span class="line">        ) &#123;</span><br><span class="line">          // keep-alive components, treat as a patch</span><br><span class="line">          const mountedNode:any = vnode</span><br><span class="line">          componentVNodeHooks.prepatch(mountedNode, mountedNode)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          const child = vnode.componentInstance = createComponentInstanceForVnode (vnode, activeInstance)</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，当vnode.componentInstance和keepAlive同时为true时，不再进入$mount过程，那mounted之前的所有钩子函数（beforeCreate、created、mounted）都不再执行。</p>
<h2 id="5-2-可重复的activated"><a href="#5-2-可重复的activated" class="headerlink" title="5.2 可重复的activated"></a>5.2 可重复的activated</h2><p>在patch的阶段，最后会执行invokeInsertHook函数，而这个函数就是去调用组件实例（VNode）自身的insert钩子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/vdom/patch.js</span></span><br><span class="line"><span class="function">function <span class="title">invokeInsertHook</span> <span class="params">(vnode, <span class="built_in">queue</span>, initial)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (isTrue(initial) &amp;&amp; isDef(vnode.parent)) &#123;</span><br><span class="line">          vnode.parent.data,pendingInsert = <span class="built_in">queue</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">for</span>(let i =<span class="number">0</span>; i&lt;<span class="built_in">queue</span>.length; ++i) &#123;</span><br><span class="line">                <span class="built_in">queue</span>[i].data.hook.insert(<span class="built_in">queue</span>[i]) <span class="comment">// 调用VNode自身的insert钩子函数</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看insert钩子：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> componentVNodeHooks = &#123;</span><br><span class="line">      <span class="comment">// init()</span></span><br><span class="line">     insert (vnode: MountedComponentVNode) &#123;</span><br><span class="line">           <span class="keyword">const</span> &#123; context, componentInstance &#125; = vnode</span><br><span class="line">           <span class="keyword">if</span> (!componentInstance._isMounted) &#123;</span><br><span class="line">                 componentInstance._isMounted = <span class="literal">true</span></span><br><span class="line">                 callHook(componentInstance, <span class="string">'mounted'</span>)</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (vnode.data.keepAlive) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (context._isMounted) &#123;</span><br><span class="line">                     queueActivatedComponent(componentInstance)</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      activateChildComponent(componentInstance, <span class="literal">true</span><span class="comment">/* direct */</span>)</span><br><span class="line">                 &#125;</span><br><span class="line">          &#125;</span><br><span class="line">         <span class="comment">// ...</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个钩子里面，调用了activateChildComponent函数递归地去执行所有子组件的activated钩子函数：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/lifecycle.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">activateChildComponent</span> (<span class="params">vm: Component, direct?: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (direct) &#123;</span><br><span class="line">    vm._directInactive = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (isInInactiveTree(vm)) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm._directInactive) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm._inactive || vm._inactive === <span class="literal">null</span>) &#123;</span><br><span class="line">    vm._inactive = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; vm.$children.length; i++) &#123;</span><br><span class="line">      activateChildComponent(vm.$children[i])</span><br><span class="line">    &#125;</span><br><span class="line">    callHook(vm, <span class="string">'activated'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相反地，deactivated钩子函数也是一样的原理，在组件实例（VNode）的destroy钩子函数中调用deactivateChildComponent函数。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Flink.juejin.im%2F%3Ftarget%3Dhttps%3A%2F%2Fustbhuangyi.github.io%2Fvue-analysis%2Fextend%2Fkeep-alive.html%23%25E5%2586%2585%25E7%25BD%25AE%25E7%25BB%2584%25E4%25BB%25B6" target="_blank" rel="noopener">Vue技术揭秘|keep-alive</a></li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Flink.juejin.im%2F%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fqiudongwei%2Fvue-analysis%2Ftree%2Fmaster%2Fvue%2F" target="_blank" rel="noopener">Vue源码</a></li>
</ul>
<p>原文地址：<a href="https://www.jianshu.com/p/9523bb439950" target="_blank" rel="noopener">https://www.jianshu.com/p/9523bb439950</a></p>

        </div>
        
          


  <section class='meta' id="footer-meta">
    <hr>
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2021-08-25T11:42:23+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>最后更新于 2021年8月25日</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/blogpost/tags/Vue/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>Vue</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/blogpost/tags/Webpack/" rel="nofollow"><i class="fas fa-hashtag" aria-hidden="true"></i>&nbsp;<p>Webpack</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=https://yangyfeng.github.io/posts/e9fee5eb.html&title=keep-alive实现原理 | 峰享会&pics=https://s2.ax1x.com/2019/07/12/Zhm4jf.jpg&summary=一、前言本文介绍的内容包括：

keep-alive用法：动态组件&amp;vue-router
keep-alive源码解析
keep-alive组件及其包裹组件的钩子
keep-alive组件及其包裹组件的渲染

二、keep-alive介绍与应用2.1 keep-alive是什么
keep-alive是一个抽象组件：它自身不会渲染一个DOM元素，也不会出现在父组件链中；使用keep-alive包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。

一个场景用户在某个列表页面选择筛选条件过滤出一份数据列表，由列表页面进入数据详情页面，再返回该列表页面，我们希望：列表页面可以保留用户的筛选（或选中）状态。 keep-alive就是用来解决这种场景。当然keep-alive不仅仅是能够保存页面/组件的状态这么简单，它还可以避免组件反复创建和渲染，有效提升系统性能。总的来说，keep-alive用于保存组件的渲染状态。
keep-alive用法
在动态组件中的应用
123&lt;keep-alive :include="whiteList" :exclude="blackList" :max="amount"&gt;     &lt;component :is="currentComponent"&gt;&lt;/component&gt;&lt;/keep-alive&gt;

在vue-router中的应用


123&lt;keep-alive :include="whiteList" :exclude="blackList" :max="amount"&gt;    &lt;router-view&gt;&lt;/router-view&gt;&lt;/keep-alive&gt;
include定义缓存白名单，keep-alive会缓存命中的组件；exclude定义缓存黑名单，被命中的组件将不会被缓存；max定义缓存组件上限，超出上限使用LRU的策略置换缓存数据。

内存管理的一种页面置换算法，对于在内存中但又不用的数据块（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。

三、源码剖析keep-alive.js内部还定义了一些工具函数，我们按住不动，先看它对外暴露的对象
123456789101112131415161718192021222324252627282930313233// src/core/components/keep-alive.jsexport default &#123;  name: 'keep-alive',  abstract: true, // 判断当前组件虚拟dom是否渲染成真实dom的关键  props: &#123;      include: patternTypes, // 缓存白名单      exclude: patternTypes, // 缓存黑名单      max: [String, Number] // 缓存的组件  &#125;,  created() &#123;     this.cache = Object.create(null) // 缓存虚拟dom     this.keys = [] // 缓存的虚拟dom的键集合  &#125;,  destroyed() &#123;    for (const key in this.cache) &#123;       // 删除所有的缓存       pruneCacheEntry(this.cache, key, this.keys)    &#125;  &#125;, mounted() &#123;   // 实时监听黑白名单的变动   this.$watch('include', val =&gt; &#123;       pruneCache(this, name =&gt; matched(val, name))   &#125;)   this.$watch('exclude', val =&gt; &#123;       pruneCache(this, name =&gt; !matches(val, name))   &#125;) &#125;, render() &#123;    // 先省略... &#125;&#125;"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://yangyfeng.github.io/posts/e9fee5eb.html&title=keep-alive实现原理 | 峰享会&pics=https://s2.ax1x.com/2019/07/12/Zhm4jf.jpg&summary=一、前言本文介绍的内容包括：

keep-alive用法：动态组件&amp;vue-router
keep-alive源码解析
keep-alive组件及其包裹组件的钩子
keep-alive组件及其包裹组件的渲染

二、keep-alive介绍与应用2.1 keep-alive是什么
keep-alive是一个抽象组件：它自身不会渲染一个DOM元素，也不会出现在父组件链中；使用keep-alive包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。

一个场景用户在某个列表页面选择筛选条件过滤出一份数据列表，由列表页面进入数据详情页面，再返回该列表页面，我们希望：列表页面可以保留用户的筛选（或选中）状态。 keep-alive就是用来解决这种场景。当然keep-alive不仅仅是能够保存页面/组件的状态这么简单，它还可以避免组件反复创建和渲染，有效提升系统性能。总的来说，keep-alive用于保存组件的渲染状态。
keep-alive用法
在动态组件中的应用
123&lt;keep-alive :include="whiteList" :exclude="blackList" :max="amount"&gt;     &lt;component :is="currentComponent"&gt;&lt;/component&gt;&lt;/keep-alive&gt;

在vue-router中的应用


123&lt;keep-alive :include="whiteList" :exclude="blackList" :max="amount"&gt;    &lt;router-view&gt;&lt;/router-view&gt;&lt;/keep-alive&gt;
include定义缓存白名单，keep-alive会缓存命中的组件；exclude定义缓存黑名单，被命中的组件将不会被缓存；max定义缓存组件上限，超出上限使用LRU的策略置换缓存数据。

内存管理的一种页面置换算法，对于在内存中但又不用的数据块（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。

三、源码剖析keep-alive.js内部还定义了一些工具函数，我们按住不动，先看它对外暴露的对象
123456789101112131415161718192021222324252627282930313233// src/core/components/keep-alive.jsexport default &#123;  name: 'keep-alive',  abstract: true, // 判断当前组件虚拟dom是否渲染成真实dom的关键  props: &#123;      include: patternTypes, // 缓存白名单      exclude: patternTypes, // 缓存黑名单      max: [String, Number] // 缓存的组件  &#125;,  created() &#123;     this.cache = Object.create(null) // 缓存虚拟dom     this.keys = [] // 缓存的虚拟dom的键集合  &#125;,  destroyed() &#123;    for (const key in this.cache) &#123;       // 删除所有的缓存       pruneCacheEntry(this.cache, key, this.keys)    &#125;  &#125;, mounted() &#123;   // 实时监听黑白名单的变动   this.$watch('include', val =&gt; &#123;       pruneCache(this, name =&gt; matched(val, name))   &#125;)   this.$watch('exclude', val =&gt; &#123;       pruneCache(this, name =&gt; !matches(val, name))   &#125;) &#125;, render() &#123;    // 先省略... &#125;&#125;"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=https://yangyfeng.github.io/posts/e9fee5eb.html&title=keep-alive实现原理 | 峰享会&pics=https://s2.ax1x.com/2019/07/12/Zhm4jf.jpg&summary=一、前言本文介绍的内容包括：

keep-alive用法：动态组件&amp;vue-router
keep-alive源码解析
keep-alive组件及其包裹组件的钩子
keep-alive组件及其包裹组件的渲染

二、keep-alive介绍与应用2.1 keep-alive是什么
keep-alive是一个抽象组件：它自身不会渲染一个DOM元素，也不会出现在父组件链中；使用keep-alive包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。

一个场景用户在某个列表页面选择筛选条件过滤出一份数据列表，由列表页面进入数据详情页面，再返回该列表页面，我们希望：列表页面可以保留用户的筛选（或选中）状态。 keep-alive就是用来解决这种场景。当然keep-alive不仅仅是能够保存页面/组件的状态这么简单，它还可以避免组件反复创建和渲染，有效提升系统性能。总的来说，keep-alive用于保存组件的渲染状态。
keep-alive用法
在动态组件中的应用
123&lt;keep-alive :include="whiteList" :exclude="blackList" :max="amount"&gt;     &lt;component :is="currentComponent"&gt;&lt;/component&gt;&lt;/keep-alive&gt;

在vue-router中的应用


123&lt;keep-alive :include="whiteList" :exclude="blackList" :max="amount"&gt;    &lt;router-view&gt;&lt;/router-view&gt;&lt;/keep-alive&gt;
include定义缓存白名单，keep-alive会缓存命中的组件；exclude定义缓存黑名单，被命中的组件将不会被缓存；max定义缓存组件上限，超出上限使用LRU的策略置换缓存数据。

内存管理的一种页面置换算法，对于在内存中但又不用的数据块（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。

三、源码剖析keep-alive.js内部还定义了一些工具函数，我们按住不动，先看它对外暴露的对象
123456789101112131415161718192021222324252627282930313233// src/core/components/keep-alive.jsexport default &#123;  name: 'keep-alive',  abstract: true, // 判断当前组件虚拟dom是否渲染成真实dom的关键  props: &#123;      include: patternTypes, // 缓存白名单      exclude: patternTypes, // 缓存黑名单      max: [String, Number] // 缓存的组件  &#125;,  created() &#123;     this.cache = Object.create(null) // 缓存虚拟dom     this.keys = [] // 缓存的虚拟dom的键集合  &#125;,  destroyed() &#123;    for (const key in this.cache) &#123;       // 删除所有的缓存       pruneCacheEntry(this.cache, key, this.keys)    &#125;  &#125;, mounted() &#123;   // 实时监听黑白名单的变动   this.$watch('include', val =&gt; &#123;       pruneCache(this, name =&gt; matched(val, name))   &#125;)   this.$watch('exclude', val =&gt; &#123;       pruneCache(this, name =&gt; !matches(val, name))   &#125;) &#125;, render() &#123;    // 先省略... &#125;&#125;"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png">
          
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACM0lEQVR42u3aS27DMAxFUe9/0+m0RVP1PlIuKvp6FAROrKMBzY+uC1+v0vX5t+t//v6U645LhgwZxzL4UtZLXP9qvVD+3B+pMmTIeACDhMI0UJLHk61Zr02GDBky0sBau5OQZMiQIaPG4GXneukyZMiQQRi8ZUYAu9LBW2pxGTJkHMjgXfe//3zLfEOGDBlHMWojyTSlIyNMHmTfrEqGDBmjGTzAdZDpN8WSWIYMGUMZr9JFml+1RRc3RYYMGQ9g1MJurQwm7Tmebn4JuDJkyBjK4CNGUsTWlssL49ZuyZAh41hGurjO5zs24s17Q4YMGeMYnVBLjl/UEj5+LGPDG0OGDBn/npGWlLV9qjXsArYMGTJGM2pJYa0p1hkwBMNOGTJkjGaQwNcJoxzTeaIMGTKmMvgBLxL+0vDKk8tgsiFDhoxBDB4Q+YEt8pR0CvnLNzJkyBjN2NXqSgvdtHhGwwwZMmSMZqAG1qZhQD8dRIMBGTJkjGOk6SBPBGv/X0xJZciQ8TBGmiySI2KtIxRky2TIkPEYBm/095O/NLlE4wEZMmSMZqSTwf4hjA1BVoYMGQ9g7AqpaduOF7eIKkOGjNGMtIlGQi1fdH+oGcNkyJBxLIMH2TR1qx2YCApX/vaQIUPGCEYt8KUFcFxh44RShgwZMmottvWdfDCAArEMGTJktFv8/IAFKY83BFwZMmQcyODDAHIsgwRNHl5RASxDhozRjFovKz0QRjarf9RDhgwZ4xgfvxci4IodEVUAAAAASUVORK5CYII='>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/wechat.png">
        
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACM0lEQVR42u3aS27DMAxFUe9/0+m0RVP1PlIuKvp6FAROrKMBzY+uC1+v0vX5t+t//v6U645LhgwZxzL4UtZLXP9qvVD+3B+pMmTIeACDhMI0UJLHk61Zr02GDBky0sBau5OQZMiQIaPG4GXneukyZMiQQRi8ZUYAu9LBW2pxGTJkHMjgXfe//3zLfEOGDBlHMWojyTSlIyNMHmTfrEqGDBmjGTzAdZDpN8WSWIYMGUMZr9JFml+1RRc3RYYMGQ9g1MJurQwm7Tmebn4JuDJkyBjK4CNGUsTWlssL49ZuyZAh41hGurjO5zs24s17Q4YMGeMYnVBLjl/UEj5+LGPDG0OGDBn/npGWlLV9qjXsArYMGTJGM2pJYa0p1hkwBMNOGTJkjGaQwNcJoxzTeaIMGTKmMvgBLxL+0vDKk8tgsiFDhoxBDB4Q+YEt8pR0CvnLNzJkyBjN2NXqSgvdtHhGwwwZMmSMZqAG1qZhQD8dRIMBGTJkjGOk6SBPBGv/X0xJZciQ8TBGmiySI2KtIxRky2TIkPEYBm/095O/NLlE4wEZMmSMZqSTwf4hjA1BVoYMGQ9g7AqpaduOF7eIKkOGjNGMtIlGQi1fdH+oGcNkyJBxLIMH2TR1qx2YCApX/vaQIUPGCEYt8KUFcFxh44RShgwZMmottvWdfDCAArEMGTJktFv8/IAFKY83BFwZMmQcyODDAHIsgwRNHl5RASxDhozRjFovKz0QRjarf9RDhgwZ4xgfvxci4IodEVUAAAAASUVORK5CYII='>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qrcode.png">
        
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
            <div class="prev-next">
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/posts/ef2e5c8.html" rel="prev" title="Github API v3 介绍文档">
                                    
                                        Github API v3 介绍文档
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/blogpost/tags/Git/"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>Git</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'keep-alive实现原理',
      tools: true
    }
  </script>

<!-- gittalk -->

  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<div id="gitalk-container" style="margin: 0 5px;"></div>
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: 'c9d3bfe9137dc2038a1a',
    clientSecret: '1ecb6999a152dad80e08c672ac5a779b92eb6ec0',
    id: window.location.pathname,
    repo: 'yangyfeng.github.io',
    owner: 'yangyfeng',
    admin: 'yangyfeng'
  })
  gitalk.render('gitalk-container')
</script>

</div>
<aside class='l_side'>
  
    
    
      
        
          
          
            <section class='widget author'>
  <div class='content material'>
    
      <div class='avatar' style="position: relative;">
        <a style="position: absolute;right: 0;top: 0;z-index: 2" href="https://github.com/yangyfeng" target="_blank" class="github-corner" aria-label="View source on Github">
          <svg width="92" height="92" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg>
        </a>
        <img class='avatar' src='https://s2.ax1x.com/2019/07/12/Zhm4jf.jpg'/>
      </div>
    
    
      <div class='text'>
        
          <h2>漫道求索</h2>
        
        
          <p><span data-chakhsu data-chakhsu-text="每写一行代码，都是人类的一次进步">每写一行代码，都是人类的一次进步</span></p>

        
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="mailto:yangyufeng.web@foxmail.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://segmentfault.com/u/yangyufeng"
              class="social fas fa-link flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://blog.csdn.net/qq_35676160"
              class="social fa fa-paper-plane flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://tool.lu/"
              class="social fas fa-toolbox flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

          
        
      
        
          
          
            <section class='widget grid'>
  
<header class='material'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content material'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          所有文章
        </a></li>
      
        <li><a class="flat-box" title="/blogpost/archives/" href="/blogpost/archives/"
          
            rel="nofollow"
          
          
          id="blogpostarchives">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
        <li><a class="flat-box" title="/blogpost/tags/" href="/blogpost/tags/"
          
            rel="nofollow"
          
          
          id="blogposttags">
          
            <i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>
          
          所有标签
        </a></li>
      
        <li><a class="flat-box" title="/friends/" href="/friends/"
          
            rel="nofollow"
          
          
          id="friends">
          
            <i class="fas fa-link fa-fw" aria-hidden="true"></i>
          
          我的友链
        </a></li>
      
        <li><a class="flat-box" title="/./atom.xml" href="/./atom.xml"
          
            rel="nofollow"
          
          
          id=".atom.xml">
          
            <i class="fas fa-rss fa-fw" aria-hidden="true"></i>
          
          RSS订阅
        </a></li>
      
        <li><a class="flat-box" title="/about/" href="/about/"
          
            rel="nofollow"
          
          
          id="about">
          
            <i class="fas fa-info-circle fa-fw" aria-hidden="true"></i>
          
          关于博主
        </a></li>
      
    </ul>
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget category'>
    
<header class='material'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blogpost/categories/"
    title="blogpost/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/blogpost/categories/个人项目/" href="/blogpost/categories/个人项目/"><div class='name'>个人项目</div><div class='badge'>(7)</div></a></li>
        
          <li><a class="flat-box" title="/blogpost/categories/前端/" href="/blogpost/categories/前端/"><div class='name'>前端</div><div class='badge'>(31)</div></a></li>
        
          <li><a class="flat-box" title="/blogpost/categories/博客文档/" href="/blogpost/categories/博客文档/"><div class='name'>博客文档</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/blogpost/categories/后端/" href="/blogpost/categories/后端/"><div class='name'>后端</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box" title="/blogpost/categories/开发工具/" href="/blogpost/categories/开发工具/"><div class='name'>开发工具</div><div class='badge'>(10)</div></a></li>
        
          <li><a class="flat-box" title="/blogpost/categories/深入前端/" href="/blogpost/categories/深入前端/"><div class='name'>深入前端</div><div class='badge'>(8)</div></a></li>
        
      </ul>
    </div>
  </section>


          
        
      
        
          
          
            
  <section class='widget tagcloud'>
    
<header class='material'>
  <div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blogpost/tags/"
    title="blogpost/tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content material'>
      <a href="/blogpost/tags/Create-React-App/" style="font-size: 15.43px; color: #8f8f8f">Create-React-App</a> <a href="/blogpost/tags/Devops/" style="font-size: 14px; color: #999">Devops</a> <a href="/blogpost/tags/Es6/" style="font-size: 15.43px; color: #8f8f8f">Es6</a> <a href="/blogpost/tags/EventLoop/" style="font-size: 14px; color: #999">EventLoop</a> <a href="/blogpost/tags/Excel/" style="font-size: 14px; color: #999">Excel</a> <a href="/blogpost/tags/Git/" style="font-size: 21.14px; color: #686868">Git</a> <a href="/blogpost/tags/GoLang/" style="font-size: 14px; color: #999">GoLang</a> <a href="/blogpost/tags/Http/" style="font-size: 16.86px; color: #868686">Http</a> <a href="/blogpost/tags/JS运行原理/" style="font-size: 16.86px; color: #868686">JS运行原理</a> <a href="/blogpost/tags/Javascript/" style="font-size: 16.86px; color: #868686">Javascript</a> <a href="/blogpost/tags/Less/" style="font-size: 14px; color: #999">Less</a> <a href="/blogpost/tags/Node/" style="font-size: 18.29px; color: #7c7c7c">Node</a> <a href="/blogpost/tags/React/" style="font-size: 19.71px; color: #727272">React</a> <a href="/blogpost/tags/V8引擎/" style="font-size: 14px; color: #999">V8引擎</a> <a href="/blogpost/tags/VsCode/" style="font-size: 15.43px; color: #8f8f8f">VsCode</a> <a href="/blogpost/tags/Vue/" style="font-size: 24px; color: #555">Vue</a> <a href="/blogpost/tags/Vue3/" style="font-size: 14px; color: #999">Vue3</a> <a href="/blogpost/tags/Webpack/" style="font-size: 16.86px; color: #868686">Webpack</a> <a href="/blogpost/tags/代码优化/" style="font-size: 14px; color: #999">代码优化</a> <a href="/blogpost/tags/前端/" style="font-size: 22.57px; color: #5f5f5f">前端</a> <a href="/blogpost/tags/前端工程化/" style="font-size: 18.29px; color: #7c7c7c">前端工程化</a> <a href="/blogpost/tags/开发工具/" style="font-size: 16.86px; color: #868686">开发工具</a> <a href="/blogpost/tags/性能优化/" style="font-size: 14px; color: #999">性能优化</a> <a href="/blogpost/tags/插件/" style="font-size: 14px; color: #999">插件</a> <a href="/blogpost/tags/数据可视化/" style="font-size: 18.29px; color: #7c7c7c">数据可视化</a> <a href="/blogpost/tags/模块化/" style="font-size: 14px; color: #999">模块化</a> <a href="/blogpost/tags/浏览器运行原理/" style="font-size: 14px; color: #999">浏览器运行原理</a> <a href="/blogpost/tags/深入前端/" style="font-size: 14px; color: #999">深入前端</a> <a href="/blogpost/tags/面试题/" style="font-size: 22.57px; color: #5f5f5f">面试题</a>
    </div>
  </section>


          
        
      
        
          
          
            
  <section class='widget related_posts'>
    
<header class='material'>
  <div><i class="fas fa-bookmark fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;相关文章</div>
  
</header>

    <div class="content material">
      <ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\f8a3109a.html" title="webpack依赖加载cdn配置" rel="bookmark">webpack依赖加载cdn配置</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\8136685c.html" title="less在vue中的使用" rel="bookmark">less在vue中的使用</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\4de2b0c3.html" title="vue.config.js配置" rel="bookmark">vue.config.js配置</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\b0d42301.html" title="vue响应式原理源码剖析" rel="bookmark">vue响应式原理源码剖析</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\d69ba86b.html" title="vue3学习起始" rel="bookmark">vue3学习起始</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\93532fe.html" title="vue性能优化" rel="bookmark">vue性能优化</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\86248f8a.html" title="vue3的新特性" rel="bookmark">vue3的新特性</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\d3643a0f.html" title="手写简易版vue，minivue的实现" rel="bookmark">手写简易版vue，minivue的实现</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\180dd8a3.html" title="globalThis对象" rel="bookmark">globalThis对象</a></h3></div></li><li class="popular-posts-item"><div class="popular-posts-title"><h3><a href="\posts\390a51fc.html" title="Babel转码器" rel="bookmark">Babel转码器</a></h3></div></li></ul>
    </div>
  </section>


          
        
      
        
          
          
            


  <section class='widget music'>
    
<header class='material'>
  <div><i class="fas fa-compact-disc fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;最近在听</div>
  
    <a class="rightBtn"
    
      rel="external nofollow noopener noreferrer"
    
    
      target="_blank"
    
    href="https://music.163.com/#/user/home?id=629541737"
    title="https://music.163.com/#/user/home?id=629541737">
    <i class="far fa-heart fa-fw"></i></a>
  
</header>

    <div class='content material'>
      
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.css">
  <div class="aplayer"
    data-theme="#242424"
    
    
    data-mode="circulation"
    data-server="netease"
    data-type="playlist"
    data-id="2868600326"
    data-volume="0.7">
  </div>
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meting@1.1.0/dist/Meting.min.js"></script>


    </div>
  </section>


          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="mailto:yangyufeng.web@foxmail.com" class="social fas fa-envelope flat-btn" target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://segmentfault.com/u/yangyufeng" class="social fas fa-link flat-btn" target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://blog.csdn.net/qq_35676160" class="social fa fa-paper-plane flat-btn" target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://tool.lu/" class="social fas fa-toolbox flat-btn" target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <!-- 统计 -->
  <div class="total-count">
    <!-- 访问量 -->
    
      <span>
        <b class="fas fa-chart-line"></b>
        总计访问：<span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>次
      </span>
    
    <!-- 文章字体个数 -->
    
      <span>
        <b class="fas fa-database"></b>
        本站字数：<span class="post-count">83.7k</span>
      </span>
    
    <!-- 网站运行时间 -->
    <span>
      <b class="fas fa-calendar-day"></b>
      网站运行时间：<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
    </span>
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>
<script>
  var now = new Date();
  function createtime() {
    //在此处修改你的建站时间
    var grt = new Date("07/01/2019 00:00:00");
    now.setTime(now.getTime() + 250);
    days = (now - grt) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
    if (String(hnum).length == 1) { hnum = "0" + hnum; } minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
    mnum = Math.floor(minutes); if (String(mnum).length == 1) { mnum = "0" + mnum; }
    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
    snum = Math.round(seconds); if (String(snum).length == 1) { snum = "0" + snum; }
    document.getElementById("timeDate").innerHTML = dnum + " 天 ";
    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
  }
  setInterval("createtime()", 250);
</script>

      <!-- 会动的小人 -->
      <!-- <div id="spig" class="spig">
        <div id="message">加载中……</div>
        <div id="mumu" class="mumu"></div>
      </div> -->
      <!-- 樱花资源 -->
      <canvas id="sakura"></canvas>
      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@2.0.2/js/instantclick-1.2.2.js" type="module"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>


  <!-- fastclick -->
  <script src="https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
  </script>



  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/img/gb3.jpg"],
          {
            duration: "60000",
            fade: "1000"
          });
        } else {
          $.backstretch(
          ["https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/img/gb3.jpg"],
          {
            duration: "60000",
            fade: "1000"
          });
        }
      });
    </script>
  











  <script src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/app.js"></script>


  <script src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/search.js"></script>




<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "[object Object]";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
  <!-- 浮动小人 -->
  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/sipng.js"></script> -->
  <!-- 页面点击小红心 -->
  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/love.js"></script> -->
  <!--动态线条背景-->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/canvas-nest.min.js" color="111,111,111" opacity='0.65' zIndex="-10" count="120" ></script>
  <!-- 飘动丝带 -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/piao.js" ></script>
  <!-- 跳动的字 -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/chakhsu.js" ></script>
  <!-- 樱花飘落 -->
  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/sakura.js" ></script> -->
  <!-- 人体时钟背景透明 -->
  <!-- <script type="text/javascript" charset="Shift_JIS" src="https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/js/clock.js"></script> -->
  <!-- 浏览器搞笑标题 -->
  <script type="text/javascript" id="bowerTitle">
    var OriginTitle = document.title;
    var titleTime;
    document.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        $('[rel="shortcut icon"]').attr('href', "https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/img/error_favicon.ico");
        document.title = '你的页面走丢了...';
        clearTimeout(titleTime);
      } else {
        $('[rel="shortcut icon"]').attr('href', "https://cdn.jsdelivr.net/gh/yufengorg/assets_source@main/img/favicon.ico");
        document.title = '欢迎回来!'
        titleTime = setTimeout(function () {
          document.title = OriginTitle;
        }, 1000)
      }
    });
  </script>
  <!-- 樱花资源 -->
  <script id="sakura_point_vsh" type="x-shader/x_vertex">
    uniform mat4 uProjection;
    uniform mat4 uModelview;
    uniform vec3 uResolution;
    uniform vec3 uOffset;
    uniform vec3 uDOF;  //x:focus distance, y:focus radius, z:max radius
    uniform vec3 uFade; //x:start distance, y:half distance, z:near fade start
    
    attribute vec3 aPosition;
    attribute vec3 aEuler;
    attribute vec2 aMisc; //x:size, y:fade
    
    varying vec3 pposition;
    varying float psize;
    varying float palpha;
    varying float pdist;
    
    //varying mat3 rotMat;
    varying vec3 normX;
    varying vec3 normY;
    varying vec3 normZ;
    varying vec3 normal;
    
    varying float diffuse;
    varying float specular;
    varying float rstop;
    varying float distancefade;
    
    void main(void) {
    // Projection is based on vertical angle
    vec4 pos = uModelview * vec4(aPosition + uOffset, 1.0);
    gl_Position = uProjection * pos;
    gl_PointSize = aMisc.x * uProjection[1][1] / -pos.z * uResolution.y * 0.5;
    
    pposition = pos.xyz;
    psize = aMisc.x;
    pdist = length(pos.xyz);
    palpha = smoothstep(0.0, 1.0, (pdist - 0.1) / uFade.z);
    
    vec3 elrsn = sin(aEuler);
    vec3 elrcs = cos(aEuler);
    mat3 rotx = mat3(
    1.0, 0.0, 0.0,
    0.0, elrcs.x, elrsn.x,
    0.0, -elrsn.x, elrcs.x
    );
    mat3 roty = mat3(
    elrcs.y, 0.0, -elrsn.y,
    0.0, 1.0, 0.0,
    elrsn.y, 0.0, elrcs.y
    );
    mat3 rotz = mat3(
    elrcs.z, elrsn.z, 0.0, 
    -elrsn.z, elrcs.z, 0.0,
    0.0, 0.0, 1.0
    );
    mat3 rotmat = rotx * roty * rotz;
    normal = rotmat[2];
    
    mat3 trrotm = mat3(
    rotmat[0][0], rotmat[1][0], rotmat[2][0],
    rotmat[0][1], rotmat[1][1], rotmat[2][1],
    rotmat[0][2], rotmat[1][2], rotmat[2][2]
    );
    normX = trrotm[0];
    normY = trrotm[1];
    normZ = trrotm[2];
    
    const vec3 lit = vec3(0.6917144638660746, 0.6917144638660746, -0.20751433915982237);
    
    float tmpdfs = dot(lit, normal);
    if(tmpdfs < 0.0) {
    normal = -normal;
    tmpdfs = dot(lit, normal);
    }
    diffuse = 0.4 + tmpdfs;
    
    vec3 eyev = normalize(-pos.xyz);
    if(dot(eyev, normal) > 0.0) {
    vec3 hv = normalize(eyev + lit);
    specular = pow(max(dot(hv, normal), 0.0), 20.0);
    }
    else {
    specular = 0.0;
    }
    
    rstop = clamp((abs(pdist - uDOF.x) - uDOF.y) / uDOF.z, 0.0, 1.0);
    rstop = pow(rstop, 0.5);
    //-0.69315 = ln(0.5)
    distancefade = min(1.0, exp((uFade.x - pdist) * 0.69315 / uFade.y));
    }
  </script>
  <script id="sakura_point_fsh" type="x-shader/x_fragment">
    #ifdef GL_ES
    //precision mediump float;
    precision highp float;
    #endif
    
    uniform vec3 uDOF;  //x:focus distance, y:focus radius, z:max radius
    uniform vec3 uFade; //x:start distance, y:half distance, z:near fade start
    
    const vec3 fadeCol = vec3(0.08, 0.03, 0.06);
    
    varying vec3 pposition;
    varying float psize;
    varying float palpha;
    varying float pdist;
    
    //varying mat3 rotMat;
    varying vec3 normX;
    varying vec3 normY;
    varying vec3 normZ;
    varying vec3 normal;
    
    varying float diffuse;
    varying float specular;
    varying float rstop;
    varying float distancefade;
    
    float ellipse(vec2 p, vec2 o, vec2 r) {
    vec2 lp = (p - o) / r;
    return length(lp) - 1.0;
    }
    
    void main(void) {
    vec3 p = vec3(gl_PointCoord - vec2(0.5, 0.5), 0.0) * 2.0;
    vec3 d = vec3(0.0, 0.0, -1.0);
    float nd = normZ.z; //dot(-normZ, d);
    if(abs(nd) < 0.0001) discard;
    
    float np = dot(normZ, p);
    vec3 tp = p + d * np / nd;
    vec2 coord = vec2(dot(normX, tp), dot(normY, tp));
    
    //angle = 15 degree
    const float flwrsn = 0.258819045102521;
    const float flwrcs = 0.965925826289068;
    mat2 flwrm = mat2(flwrcs, -flwrsn, flwrsn, flwrcs);
    vec2 flwrp = vec2(abs(coord.x), coord.y) * flwrm;
    
    float r;
    if(flwrp.x < 0.0) {
    r = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.36, 0.96) * 0.5);
    }
    else {
    r = ellipse(flwrp, vec2(0.065, 0.024) * 0.5, vec2(0.58, 0.96) * 0.5);
    }
    
    if(r > rstop) discard;
    
    vec3 col = mix(vec3(1.0, 0.8, 0.75), vec3(1.0, 0.9, 0.87), r);
    float grady = mix(0.0, 1.0, pow(coord.y * 0.5 + 0.5, 0.35));
    col *= vec3(1.0, grady, grady);
    col *= mix(0.8, 1.0, pow(abs(coord.x), 0.3));
    col = col * diffuse + specular;
    
    col = mix(fadeCol, col, distancefade);
    
    float alpha = (rstop > 0.001)? (0.5 - r / (rstop * 2.0)) : 1.0;
    alpha = smoothstep(0.0, 1.0, alpha) * palpha;
    
    gl_FragColor = vec4(col * 0.5, alpha);
    }
  </script>
  <!-- effects -->
  <script id="fx_common_vsh" type="x-shader/x_vertex">
    uniform vec3 uResolution;
    attribute vec2 aPosition;
    
    varying vec2 texCoord;
    varying vec2 screenCoord;
    
    void main(void) {
    gl_Position = vec4(aPosition, 0.0, 1.0);
    texCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);
    screenCoord = aPosition.xy * vec2(uResolution.z, 1.0);
    }
  </script>
  <script id="bg_fsh" type="x-shader/x_fragment">
    #ifdef GL_ES
    //precision mediump float;
    precision highp float;
    #endif
    
    uniform vec2 uTimes;
    
    varying vec2 texCoord;
    varying vec2 screenCoord;
    
    void main(void) {
    vec3 col;
    float c;
    vec2 tmpv = texCoord * vec2(0.8, 1.0) - vec2(0.95, 1.0);
    c = exp(-pow(length(tmpv) * 1.8, 2.0));
    col = mix(vec3(0.02, 0.0, 0.03), vec3(0.96, 0.98, 1.0) * 1.5, c);
    gl_FragColor = vec4(col * 0.5, 1.0);
    }
  </script>
  <script id="fx_brightbuf_fsh" type="x-shader/x_fragment">
    #ifdef GL_ES
    //precision mediump float;
    precision highp float;
    #endif
    uniform sampler2D uSrc;
    uniform vec2 uDelta;
    
    varying vec2 texCoord;
    varying vec2 screenCoord;
    
    void main(void) {
    vec4 col = texture2D(uSrc, texCoord);
    gl_FragColor = vec4(col.rgb * 2.0 - vec3(0.5), 1.0);
    }
  </script>
  <script id="fx_dirblur_r4_fsh" type="x-shader/x_fragment">
    #ifdef GL_ES
    //precision mediump float;
    precision highp float;
    #endif
    uniform sampler2D uSrc;
    uniform vec2 uDelta;
    uniform vec4 uBlurDir; //dir(x, y), stride(z, w)
    
    varying vec2 texCoord;
    varying vec2 screenCoord;
    
    void main(void) {
    vec4 col = texture2D(uSrc, texCoord);
    col = col + texture2D(uSrc, texCoord + uBlurDir.xy * uDelta);
    col = col + texture2D(uSrc, texCoord - uBlurDir.xy * uDelta);
    col = col + texture2D(uSrc, texCoord + (uBlurDir.xy + uBlurDir.zw) * uDelta);
    col = col + texture2D(uSrc, texCoord - (uBlurDir.xy + uBlurDir.zw) * uDelta);
    gl_FragColor = col / 5.0;
    }
  </script>
  <!-- effect fragment shader template -->
  <script id="fx_common_fsh" type="x-shader/x_fragment">
    #ifdef GL_ES
    //precision mediump float;
    precision highp float;
    #endif
    uniform sampler2D uSrc;
    uniform vec2 uDelta;
    
    varying vec2 texCoord;
    varying vec2 screenCoord;
    
    void main(void) {
    gl_FragColor = texture2D(uSrc, texCoord);
    }
  </script>
  <!-- post processing -->
  <script id="pp_final_vsh" type="x-shader/x_vertex">
    uniform vec3 uResolution;
    attribute vec2 aPosition;
    varying vec2 texCoord;
    varying vec2 screenCoord;
    void main(void) {
    gl_Position = vec4(aPosition, 0.0, 1.0);
    texCoord = aPosition.xy * 0.5 + vec2(0.5, 0.5);
    screenCoord = aPosition.xy * vec2(uResolution.z, 1.0);
    }
  </script>
  <script id="pp_final_fsh" type="x-shader/x_fragment">
    #ifdef GL_ES
    //precision mediump float;
    precision highp float;
    #endif
    uniform sampler2D uSrc;
    uniform sampler2D uBloom;
    uniform vec2 uDelta;
    varying vec2 texCoord;
    varying vec2 screenCoord;
    void main(void) {
    vec4 srccol = texture2D(uSrc, texCoord) * 2.0;
    vec4 bloomcol = texture2D(uBloom, texCoord);
    vec4 col;
    col = srccol + bloomcol * (vec4(1.0) + srccol);
    col *= smoothstep(1.0, 0.0, pow(length((texCoord - vec2(0.5)) * 2.0), 1.2) * 0.5);
    col = pow(col, vec4(0.45454545454545)); //(1.0 / 2.2)
    
    gl_FragColor = vec4(col.rgb, 1.0);
    gl_FragColor.a = 1.0;
    }
  </script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":100,"height":200},"mobile":{"show":false,"scale":0.7},"log":false});</script><script>!function(e){var r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function t(){for(var c=0;c<r.length;c++)t=r[c],void 0,0<=(n=t.getBoundingClientRect()).top&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=r[c];t=o,n=function(){r=r.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}t(),e.addEventListener("scroll",function(){!function(t,n){clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)}(t,e)})}(this);</script></body>
</html>
